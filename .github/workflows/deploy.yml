name: Build and Release

# è§¦å‘æ¡ä»¶
on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # æ¨é€åˆ° main åˆ†æ”¯æˆ–æ ‡ç­¾æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches:
      - main
    tags:
      - 'v*'
    paths:
      - 'thus-frontends/thus-web/**'
      - 'thus-backends/thus-server/**'
      - '.github/workflows/deploy.yml'

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  build-and-release:
    name: æ„å»ºå¹¶å‘å¸ƒ Release
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: ğŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # 3. è®¾ç½® pnpm
      - name: ğŸ”§ è®¾ç½® pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      # 4. ç¼“å­˜ä¾èµ–
      - name: ğŸ“¦ ç¼“å­˜ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            **/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}-
            ${{ runner.os }}-pnpm-

      # 5. å®‰è£…æ ¹ç›®å½•ä¾èµ–
      - name: ğŸ“¦ å®‰è£…æ ¹ç›®å½•ä¾èµ–
        run: |
          echo "ğŸ“¦ å®‰è£…æ ¹ç›®å½•ä¾èµ–..."
          pnpm install --frozen-lockfile

      # 6. å®‰è£…å¹¶æ„å»ºå‰ç«¯
      - name: ğŸ—ï¸ æ„å»ºå‰ç«¯
        run: |
          echo "ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–..."
          cd thus-frontends/thus-web
          pnpm install --frozen-lockfile

          echo "ğŸ—ï¸ æ„å»ºå‰ç«¯..."
          pnpm build

          echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ!"
          ls -lh dist/

      # 7. å®‰è£…å¹¶æ„å»ºåç«¯
      - name: ğŸ—ï¸ æ„å»ºåç«¯
        run: |
          echo "ğŸ“¦ å®‰è£…åç«¯ä¾èµ–..."
          cd thus-backends/thus-server
          pnpm install --frozen-lockfile

          echo "ğŸ—ï¸ ç¼–è¯‘ TypeScript..."
          pnpm build

          echo "âœ… åç«¯æ„å»ºå®Œæˆ!"
          ls -lh dist/

      # 8. å‡†å¤‡å‘å¸ƒåŒ…
      - name: ğŸ“¦ å‡†å¤‡å‘å¸ƒåŒ…
        run: |
          echo "ğŸ“¦ åˆ›å»ºå‘å¸ƒç›®å½•..."
          mkdir -p release-package/frontend
          mkdir -p release-package/backend

          # å¤åˆ¶å‰ç«¯æ„å»ºäº§ç‰©
          echo "ğŸ“‹ å¤åˆ¶å‰ç«¯æ–‡ä»¶..."
          cp -r thus-frontends/thus-web/dist/* release-package/frontend/

          # å¤åˆ¶åç«¯æ„å»ºäº§ç‰©å’Œå¿…è¦æ–‡ä»¶
          echo "ğŸ“‹ å¤åˆ¶åç«¯æ–‡ä»¶..."
          cp -r thus-backends/thus-server/dist release-package/backend/
          cp thus-backends/thus-server/package.json release-package/backend/
          cp thus-backends/thus-server/pnpm-lock.yaml release-package/backend/
          cp thus-backends/thus-server/ecosystem.config.js release-package/backend/ || true
          cp thus-backends/thus-server/.env.example release-package/backend/

          # åˆ›å»ºåç«¯å¿…è¦çš„ç›®å½•
          echo "ğŸ“ åˆ›å»ºåç«¯ç›®å½•..."
          mkdir -p release-package/backend/logs
          mkdir -p release-package/backend/pids
          mkdir -p release-package/backend/uploads

          # åˆ›å»ºéƒ¨ç½²è¯´æ˜æ–‡ä»¶
          echo "ğŸ“ åˆ›å»ºéƒ¨ç½²è¯´æ˜..."
          cat > release-package/README.md << 'EOFREADME'
          # Thus-Note ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²åŒ…

          ## åŒ…å«å†…å®¹

          - frontend/ - å‰ç«¯é™æ€æ–‡ä»¶ (Vue 3)
          - backend/ - åç«¯ Node.js ä»£ç 

          ## éƒ¨ç½²æ­¥éª¤

          ### 1. ä¸Šä¼ åˆ°æœåŠ¡å™¨

          å°†æ•´ä¸ªå‹ç¼©åŒ…ä¸Šä¼ åˆ°æœåŠ¡å™¨å¹¶è§£å‹:

          tar -xzf thus-note-*.tar.gz
          cd thus-note-*

          ### 2. éƒ¨ç½²å‰ç«¯

          ä¸Šä¼ å‰ç«¯æ–‡ä»¶åˆ°ç½‘ç«™æ ¹ç›®å½•:
          cp -r frontend/* /www/wwwroot/thus.caiths.com/frontend/

          ### 3. éƒ¨ç½²åç«¯

          ä¸Šä¼ åç«¯æ–‡ä»¶:
          cp -r backend/* /www/wwwroot/thus.caiths.com/backend/
          cd /www/wwwroot/thus.caiths.com/backend

          é…ç½®ç¯å¢ƒå˜é‡ (é¦–æ¬¡éƒ¨ç½²):
          cp .env.example .env
          nano .env

          å®‰è£…ç”Ÿäº§ä¾èµ–:
          pnpm install --production

          å¯åŠ¨æœåŠ¡ (ä½¿ç”¨ PM2):
          pm2 start ecosystem.config.js
          pm2 save
          pm2 startup

          ### 4. é…ç½® Nginx

          åœ¨å®å¡”é¢æ¿é…ç½® Nginx åå‘ä»£ç†ï¼Œå‚è€ƒé¡¹ç›®ä¸­çš„ deploy/nginx.conf

          ### 5. ç”³è¯· SSL è¯ä¹¦

          åœ¨å®å¡”é¢æ¿ç”³è¯· Let's Encrypt å…è´¹è¯ä¹¦

          ## éªŒè¯éƒ¨ç½²

          - è®¿é—®: https://thus.caiths.com
          - å¥åº·æ£€æŸ¥: https://thus.caiths.com/health

          ## è¯¦ç»†æ–‡æ¡£

          å®Œæ•´éƒ¨ç½²æ–‡æ¡£: https://github.com/poboll/thus-note/blob/main/deploy/DEPLOYMENT.md

          ## ç¯å¢ƒè¦æ±‚

          - Node.js >= 18
          - MongoDB >= 5.0
          - Redis >= 6.0
          - pnpm >= 8

          ## ç¯å¢ƒå˜é‡é…ç½®

          ç¼–è¾‘ .env æ–‡ä»¶:

          NODE_ENV=production
          PORT=3000
          MONGODB_URI=mongodb://ç”¨æˆ·:å¯†ç @127.0.0.1:27017/thus-note?authSource=admin
          REDIS_HOST=127.0.0.1
          REDIS_PASSWORD=ä½ çš„Rediså¯†ç 
          JWT_SECRET=ç”Ÿæˆä¸€ä¸ªå¼ºéšæœºå¯†é’¥

          EOFREADME

          echo "âœ… å‘å¸ƒåŒ…å‡†å¤‡å®Œæˆ!"
          du -sh release-package/*

      # 9. åˆ›å»ºå‹ç¼©åŒ…
      - name: ğŸ“¦ åˆ›å»ºå‹ç¼©åŒ…
        run: |
          # è·å–ç‰ˆæœ¬å·å’Œæ—¶é—´æˆ³
          VERSION=$(date +%Y%m%d-%H%M%S)
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          fi

          PACKAGE_NAME="thus-note-${VERSION}.tar.gz"

          echo "ğŸ“¦ æ‰“åŒ…: $PACKAGE_NAME"
          cd release-package
          tar -czf ../$PACKAGE_NAME .
          cd ..

          # è®¡ç®— SHA256
          sha256sum $PACKAGE_NAME > ${PACKAGE_NAME}.sha256

          echo "âœ… æ‰“åŒ…å®Œæˆ!"
          ls -lh $PACKAGE_NAME*

          # ä¿å­˜æ–‡ä»¶åä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      # 10. ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: thus-note-${{ env.VERSION }}
          path: |
            ${{ env.PACKAGE_NAME }}
            ${{ env.PACKAGE_NAME }}.sha256
          retention-days: 90

      # 11. åˆ›å»º Release (ä»…åœ¨æ¨é€æ ‡ç­¾æˆ– main åˆ†æ”¯æ—¶)
      - name: ğŸ‰ åˆ›å»º GitHub Release
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          body: |
            ## ğŸ‰ Thus-Note å‘å¸ƒ ${{ env.VERSION }}

            ### ğŸ“¦ ä¸‹è½½

            ä¸‹è½½å‹ç¼©åŒ…å¹¶ä¸Šä¼ åˆ°æœåŠ¡å™¨:

            1. ä¸‹è½½ `thus-note-${{ env.VERSION }}.tar.gz`
            2. ä¸Šä¼ åˆ°æœåŠ¡å™¨å¹¶è§£å‹
            3. æŒ‰ç…§å‹ç¼©åŒ…å†…çš„ `README.md` è¿›è¡Œéƒ¨ç½²

            ### ğŸ“ éƒ¨ç½²è¯´æ˜

            å®Œæ•´éƒ¨ç½²æ–‡æ¡£: [DEPLOYMENT.md](https://github.com/poboll/thus-note/blob/main/deploy/DEPLOYMENT.md)

            ### âœ… éªŒè¯ SHA256

            ```bash
            sha256sum -c thus-note-${{ env.VERSION }}.tar.gz.sha256
            ```

            ### ğŸ—‚ï¸ åŒ…å«å†…å®¹

            - âœ… å‰ç«¯é™æ€æ–‡ä»¶ (Vue 3)
            - âœ… åç«¯ Node.js ä»£ç  (TypeScript ç¼–è¯‘)
            - âœ… PM2 é…ç½®æ–‡ä»¶
            - âœ… ç¯å¢ƒå˜é‡æ¨¡æ¿
            - âœ… éƒ¨ç½²è¯´æ˜æ–‡æ¡£

            ### ğŸ’¾ ç¯å¢ƒè¦æ±‚

            - Node.js >= 18
            - MongoDB >= 5.0
            - Redis >= 6.0
            - pnpm >= 8

            ---

            **æäº¤**: ${{ github.sha }}
            **åˆ†æ”¯**: ${{ github.ref }}
            **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
          files: |
            ${{ env.PACKAGE_NAME }}
            ${{ env.PACKAGE_NAME }}.sha256
          draft: false
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 12. æ„å»ºæ€»ç»“
      - name: ğŸ“Š æ„å»ºæ€»ç»“
        if: always()
        run: |
          echo "================================"
          echo "ğŸ“Š æ„å»ºæ€»ç»“"
          echo "================================"
          echo "âœ… ç‰ˆæœ¬: ${{ env.VERSION }}"
          echo "âœ… åŒ…å: ${{ env.PACKAGE_NAME }}"
          echo "âœ… å¤§å°: $(ls -lh ${{ env.PACKAGE_NAME }} | awk '{print $5}')"
          echo ""
          echo "ğŸ“¥ ä¸‹è½½åœ°å€:"
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "  GitHub Release: https://github.com/${{ github.repository }}/releases/tag/${{ env.VERSION }}"
            echo "  æˆ–é€šè¿‡ Actions é¡µé¢ä¸‹è½½æ„å»ºäº§ç‰©"
          else
            echo "  é€šè¿‡ Actions é¡µé¢ä¸‹è½½æ„å»ºäº§ç‰©"
          fi
          echo ""
          echo "ğŸ“š éƒ¨ç½²æ–‡æ¡£:"
          echo "  https://github.com/${{ github.repository }}/blob/main/deploy/DEPLOYMENT.md"
          echo "================================"
